<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="database-document">
  <template>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'database-document',

        properties: {
          auto: {
            type: Boolean,
            value: false
          },
          byId: String,
          attachments: {
            type: Boolean,
            value: false
          },
          doc: {
            type: Object,
            notify: true
          },
          lastError: {
            type: String,
            readOnly: true,
            notify: true
          },
          type: String,
          restSingle: {
            type: String,
            value: '/rest/v1/failed'
          },
          restDelete: {
            type: String,
            value: '/rest/v1/failed'
          }
        },

        observers: [
          '_start(byId)'
        ],

        _start: function() {
          if (this.auto) {
            this.generateRequest();
          }
        },

        _restRequest(method, url, params = null, body = null) {
          var ajax = document.createElement('iron-ajax');
          ajax.url = url;
          ajax.contentType = 'application/json';
          ajax.handleAs = 'json';
          ajax.method = method;
          ajax.params = params;
          ajax.body = body;
          return ajax.generateRequest();
        },

        generateRequest() {
          var ajax = document.createElement('iron-ajax');
          ajax.url = this.restSingle;
          ajax.contentType = 'application/json';
          ajax.handleAs = 'json';
          ajax.method = 'GET';
          ajax.params = {
            attachments: this.attachments
          };
          ajax.generateRequest().completes.then(e => {
            this.doc = e.response;
          }).catch(e => {
            this._setLastError(e);
          });
        },

        createDocument(doc) {
          return new Promise((resolve, reject) => {
            var ajax = document.createElement('iron-ajax');
            ajax.url = '/db/' + doc.id;
            ajax.contentType = 'application/json';
            ajax.body = doc;
            ajax.handleAs = 'json';
            ajax.method = 'PUT';
            ajax.generateRequest().completes.then(e => {
              doc._rev = e.response.rev;
              resolve(doc);
            }).catch(e => {
              reject(e);
            });
          });
        },

        deleteDocument(doc) {
          this._restRequest('DELETE', this.restDelete).completes.then(e => {
              
          }).catch(e => {
            console.error("database-document", "deleteDocument", "failed:", e);
          });
        }
      });
    })();
  </script>
</dom-module>
